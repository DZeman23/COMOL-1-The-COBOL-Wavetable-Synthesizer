# COMOL-1 Changelog

## [1.2] — 2025-02-21

### Working-Storage — Data Type Changes

- **`WAVE-SOURCE-CHOICE`** — Removed `COMP-3`. Left as plain `PIC 9(1)` with an
  explanatory comment; ensures `ACCEPT` works correctly across all compilers.
- **`TVF-DEPTH`** — Widened from `PIC S9(3)` to `PIC S9(3)V9(10)`, giving the
  envelope depth field 10 decimal places of sub-integer precision for smoother
  modulation curves.
- **Most computational groups** migrated from `COMP-3` (packed decimal) to
  `COMP-5` (native binary integer) for faster arithmetic. Affected groups:
  `FILTER-MATH-VARS`, `BIQUAD-COEFFICIENTS`, `DELAY-LINES`, `ANALOGUE-PARAMS`,
  `ANALOGUE-MATH`, `DRIFT-ENGINE`, `USER-INPUT-HELPERS`, `FILE-READER-VARS`,
  `PITCH-MATH`, `PROGRESS-VARS`, `WAVE-GENERATOR-CONSTANTS`, `SINE-MATH-VARS`,
  `SINC-CONSTANTS`, `POLYPHASE-CONSTANTS`, `SINC-VARS`, `RESAMPLE-POINTERS`,
  `GRIT-CONTROL-VARS`, `LINEAR-MATH`, `JD-PARAMS`, `CUT-PARAMS`,
  `TVF-CONTROL-VARS`, `PCM-WRITING`, and `SAMPLE-RATE`.

### Working-Storage — Field Precision Changes

- **`SAMPLE-WORK-AREA` / `FILTERED-SAMPLE`** — Integer part reduced from
  `S9(12)` to `S9(5)` to match the actual 16-bit PCM hardware range and avoid
  wasted storage.
- **`DELAY-LINES` (X1, X2, Y1, Y2)** — Integer part reduced from `S9(12)` to
  `S9(6)` for the same reason.
- **`ANALOGUE-MATH`** — Integer and fractional parts restructured throughout to
  tighter, higher-precision layouts (`POS-FACTOR`/`NEG-FACTOR` now
  `S9(3)V9(15)`; `UPPER-ADJ`/`LOWER-ADJ` now `S9(5)V9(13)`; intermediates
  reworked accordingly).

### Working-Storage — New Variables

- **`FILTER-COEFF-LUT`** — New 1001-entry array (`L-B0` through `L-A2`,
  each `S9(3)V9(8) COMP-5`), one entry per 0.1-knob-step across the 0–100
  range. Pre-built at startup so the hot audio loop never has to re-compute
  trig.
- **`LUT-MATH-VARS`** — New working group holding `LUT-KNOB-TEMP` for
  interpolation work inside `GENERATE-FILTER-LUT`.
- **`COEFF-SMOOTH-VARS`** — New group containing:
  - `SMOOTHED-DEPTH PIC S9(3)V9(8)` (initial value 77) — running smoothed
    target for the cutoff.
  - `SMOOTH-RATE PIC 9V9(8)` (value 0.005) — one-pole IIR coefficient.
- **`WEIGHT-SUM` in `SINC-VARS`** — Field that was missing from v1.1 restored.

### Procedure Division — `MAIN-LOGIC`

- Added `PERFORM GENERATE-FILTER-LUT` between `CALCULATE-FILTER-COEFFICIENTS`
  and `GET-ENVELOPE-SETTINGS`, so the LUT is fully populated before the
  envelope stages begin.

### Procedure Division — `RECALCULATE-COEFFICIENTS` (rewritten)

- Old logic did a raw knob-to-table-index conversion and called direct lookup
  tables (`TBL-SINE-VAL`, `TBL-COS-VAL`) followed by `INIT-COEFFICIENTS` on
  every sample.
- New logic:
  1. Computes `DEPTH-CALC = BASE-CUTOFF + (CURRENT-KNOB * TVF-DEPTH / 100.0)`.
  2. Clamps result to 0–100.
  3. Applies a **one-pole IIR smoother** (`SMOOTHED-DEPTH`) to remove stepping
     artefacts.
  4. Maps `SMOOTHED-DEPTH` to a **direct LUT index** (1–1001) and fetches
     `B0`–`A2` coefficients with five plain `MOVE` statements — no `SEARCH`,
     no trig, no `INIT-COEFFICIENTS` call per sample.

### Procedure Division — `INIT-SINC-TABLE` (rewritten)

- Old logic called `NORMALIZE-ANGLE` and then `FIND-SINE-FROM-OMEGA` /
  `FIND-COS-FROM-OMEGA` (binary `SEARCH`) for every kernel tap at every phase
  step, which was very slow at startup.
- New logic uses `FUNCTION SIN` and `FUNCTION COS` intrinsics directly on
  `PI-VAL * SINC-X` / `PI-VAL * SINC-X / KERNEL-RADIUS`, removing all
  dependence on table searches during initialisation.

### Procedure Division — `NORMALIZE-ANGLE`

- Kept in place as a compatibility stub (no longer called by `INIT-SINC-TABLE`
  but retained in case future code needs it).

### Procedure Division — `GENERATE-FILTER-LUT` (new paragraph)

- Runs once at startup after `CALCULATE-FILTER-COEFFICIENTS`.
- Iterates 1001 times (LUT-IDX 1–1001), mapping each index to a knob position
  in the range 0.0–100.0 with 0.1 resolution.
- For each step: splits knob value into integer and fractional parts,
  linearly interpolates between adjacent frequency-table entries, computes
  omega, performs the `SEARCH`-based sine/cosine lookups (acceptable here
  since this only runs once), calculates alpha, calls `INIT-COEFFICIENTS`, and
  stores the five resulting coefficients into the LUT.
- Displays `"Pre-calculating TVF Coefficient Table..."` at start and
  `"Filter LUT Ready."` on completion.
